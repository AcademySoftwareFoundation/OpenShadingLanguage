# Copyright Contributors to the Open Shading Language project.
# SPDX-License-Identifier: BSD-3-Clause
# https://github.com/AcademySoftwareFoundation/OpenShadingLanguage

name: Analysis

on:
  schedule:
    # Run nightly while we're still working our way through the warnings
    - cron: "0 8 * * *"
    # Run unconditionally once weekly
    # - cron: "0 0 * * 0"
  push:
    # Run on pushes only to main or if the branch name contains "analysis"
    branches:
      - main
      - '*analysis*'
      - '*sonar*'
    paths:
      - '**'
      - '!**.md'
      - '!**.rst'
      - '!**/ci.yml'
      - '!**/docs.yml'
      - '!**/scorecard.yml'
      - '!**.properties'
      - '!docs/**'
  # Run analysis on PRs only if the branch name indicates that the purpose of
  # the PR is related to the Sonar analysis. We don't run on every PR because
  # the analysis run is very expensive and just isn't usually necessary.
  pull_request:
    branches:
      - '*analysis*'
      - '*sonar*'
  # Allow manual kicking off of the workflow from github.com
  workflow_dispatch:

permissions: read-all

# Allow subsequent pushes to the same PR or REF to cancel any previous jobs.
concurrency:
  group: ${{ github.workflow }}-${{ github.event.pull_request.number || github.ref }}
  cancel-in-progress: true


jobs:

  sonar-analysis:
    if: |
      github.repository == 'AcademySoftwareFoundation/OpenShadingLanguage'
    name: "${{matrix.desc}}"
    uses: ./.github/workflows/build-steps.yml
    with:
      nametag: ${{ matrix.nametag || 'unnamed!' }}
      runner: ${{ matrix.runner || 'ubuntu-latest' }}
      container: ${{ matrix.container }}
      cc_compiler: ${{ matrix.cc_compiler || 'gcc' }}
      cxx_compiler: ${{ matrix.cxx_compiler || 'g++' }}
      cxx_std: ${{ matrix.cxx_std || '17' }}
      build_type: ${{ matrix.build_type || 'Release' }}
      depcmds: ${{ matrix.depcmds }}
      extra_artifacts: ${{ matrix.extra_artifacts }}
      fmt_ver: ${{ matrix.fmt_ver }}
      opencolorio_ver: ${{ matrix.opencolorio_ver }}
      openexr_ver: ${{ matrix.openexr_ver }}
      openimageio_ver: ${{ matrix.openimageio_ver }}
      pybind11_ver: ${{ matrix.pybind11_ver }}
      python_ver: ${{ matrix.python_ver }}
      setenvs: ${{ matrix.setenvs }}
      simd: ${{ matrix.simd }}
      batched: ${{ matrix.batched }}
      skip_build: ${{ matrix.skip_build }}
      skip_tests: ${{ matrix.skip_tests }}
      abi_check: ${{ matrix.abi_check }}
      build_docs: ${{ matrix.build_docs }}
      generator: ${{ matrix.generator }}
      ctest_args: ${{ matrix.ctest_args }}
      ctest_test_timeout: ${{ matrix.ctest_test_timeout || '800' }}
      coverage: ${{ matrix.coverage || 0 }}
      sonar: ${{ matrix.sonar || 0 }}
    strategy:
      fail-fast: false
      matrix:
        include:
          - desc: sonar VP2024 gcc11/C++17 llvm17 py3.11 oiio-rel avx2
            nametag: static-analysis-sonar
            runner: ubuntu-latest
            container: aswftesting/ci-osl:2024-clang17
            cxx_std: 17
            openimageio_ver: release
            python_ver: "3.11"
            pybind11_ver: v2.12.0
            simd: avx2,f16c
            batched: b8_AVX2,b16_AVX512
            coverage: 1
            # skip_tests: 1
            sonar: 1
            setenvs: export xSONAR_SCANNER_VERSION=4.7.0.2747
                            SONAR_SERVER_URL="https://sonarcloud.io"
                            BUILD_WRAPPER_OUT_DIR=/__w/OpenShadingLanguage/OpenShadingLanguage/bw_output
                            OSL_CMAKE_BUILD_WRAPPER="build-wrapper-linux-x86-64 --out-dir /__w/OpenShadingLanguage/OpenShadingLanguage/bw_output"
                            OSL_CMAKE_BUILD_TYPE=Debug
                            OSL_CMAKE_FLAGS="-DOSL_TEST_BIG_TIMEOUT=1200 -DUSE_QT=0"
                            CMAKE_UNITY_BUILD=OFF
                            CODECOV=1
                            TESTRENDER_AA=1
                            OSL_TESTSUITE_SKIP_DIFF=1
                            CTEST_TEST_TIMEOUT=1200
                            CTEST_EXCLUSIONS="broken|noise-reg.regress|noise-gabor-reg.regress"

